- Network namespaces are used by containers (e.g. Docker) to implement network isolation

- If your host was your house, then namespaces are the rooms within the house
	- The rooms help in providing privacy to each child, each child can only see what's within his/her room but cannot see what happens outside of their room
	- However, as the parent, you have visibility into all the rooms as well as other areas in the house

![[nn-1.png]]

- When you create a container, you want to make sure it is isolated on the host (i.e. it does not see any other processes or containers); thus, we create a special 'room' for it on the host using a namespace

- When a namespace is created for a container, as far as the container is concerned, it can only see the processes run by itself and thinks that it is on its own host

- When a namespace is created (on a container), the underlying host has visibility into all of the processes including those running inside the containers
	- This can be seen when you list the processes from within the container

![[nn-2.png]]

- When you list the processes as a root user from the underlying host, you see all of the processes including those running on the container
	- This time with a different process id

![[nn-3.png]]

- When it comes to networking, the host has its own interface that connects to the Local Area Network (LAN), along with its own routing table and ARP table

![[nn-4.png]]

- ARP stands for Address Resolution Protocol and the `arp` command manipulates the system's ARP cache

- When a container is created, a network namespace is created for it, that way it has no visibility to any other network's information on the host
	- Within its network namespace, the container can have its own virtual interfaces, routing tables, and ARP tables

- To add a new network namespace in the container, run the `ip netns add` command with the name of the network namespace

![[nn-5.png]]

- To list the network namespaces, run the `ip netns` command

![[nn-6.png]]


- Remember: to list interfaces on your host (or container), run the `ip link` command

![[nn-7.png]]

- To view interfaces in the network namespace, prefix the `ip link` command with the `ip netns exec` command followed by the name of the network namespace

![[nn-8.png]]

- Another way to view the network namespace interfaces is to add the "-n" optionÂ  followed by the network namespace name to the `ip link` command

![[nn-9.png]]

- If you run the `arp` command on the host, you see a list of entries but if run inside of the container (for the first time) you see no entries

![[nn-10.png]]

- If you run the `route` command on the host, you see a list of entries but if run inside of the container (for the first time) you see no entries

![[nn-11.png]]

- When you initially add a network namespace, it will have no connectivity, no interfaces of its own and cannot see the underlying host network

- To establish connectivity between network namespaces, you can connect them using a virtual ethernet pair (or a virtual cable). This is often referred to as a pipe with two interfaces on the ends
	- The ends of the pipe have their own names (which is whatever you give them but should be indicative of the namespace it's for)

- veth pairs can act as tunnels between network namespaces to create a bridge to a physical network device in another namespace
	- These can also be used as standalone network devices

- To create the veth pair (virtual cable), run the `ip link add` command with the type set to veth and specify the two ends (the interfaces)

![[nn-12.png]]

- After creating the pipe between the two interfaces, the next step is to attach the interface to the correct network namespace by using the `ip link set` command followed by the name of the interface and the name of the network namespace

![[nn-13.png]]

- After attaching interfaces to their namespaces, use the `ip addr add` command to assign the interfaces IP addresses within the namespace

![[nn-14.png]]

- After assigning IP addresses to the interfaces within their network namespaces, we then bring up the networks using the `ip link set up` command for each device (interface) within their respective namespaces

![[nn-15.png]]

- After bringing the interfaces up, try to ping from one namespace to reach the other or/and look at the ARP table of each namespace to see the other namespace identified as a neighbor

![[nn-16.png]]

- If you come across issues where you can't ping one namespace from the other, make sure you set the NETMASK (CIDR) while setting the IP address

- Another thing to check if you can't ping between namespaces is FirewallD/IPTables rules. Either add rules to IPTables to allow traffic from one namespace to another.
	- Or disable IPTables all together (only in a learning environment)

### Bridge

- When there are many namespaces and you want to enable all of them to communicate with each other, you create a virtual network inside of your host

- To create a network you need a switch, thus to create a virtual network you need a virtual switch
	- You create a virtual switch within a host and connect the namespaces to it

- To create a virtual switch on a host, there are native solutions such as Linux Bridge and vSwitch

- To create an internal bridge network, we add a new interface to the host using the `ip link add` command with type set to bridge
	- As far as the host is concerned, it is just another interface which now appears in the output of the `ip link` command

![[nn-17.png]]

- Use the `ip link set dev <device name> up` command to bring up the virtual network

- For the namespace, the virtual interface is like a switch that it can connect to
	- Think of it as an interface for the host and a switch for the namespace
	- The next step is to connect the namespaces

- The eth pair (pipe) previously created is no longer needed because it was created to connect the namespaces to each other directly; now we will be connecting the namespaces to a bridge network (virtual switch)

- To connect networks to a bridge, new cables are needed because the direct pipe doesn't make sense anymore

- To delete a pipe, use the `ip link del` command
	- When you delete the pipe with one end, the other end is automatically deleted

![[nn-18.png]]

- To connect network interfaces to a bridge, run the `ip link add` command again but this time, the peer end of the pipe will be the bridge as it connects to the bridge network

![[nn-19.png]]

   - The naming convention helps identify the interfaces that associate with each namespace

- To attach one end of the interface to its namespace, use the `ip link set <interface name> netns <network namespace name>` command and to attach the other end to its bridge network, run the `ip link set` command on the bridge and specify the master for it as the virtual network

![[nn-20.png]]

![[nn-21.png]]

- Set the IP addresses for the interfaces to turn them to UP

![[nn-22.png]]

- Remember: the bridge switch is actually a network interface for the host, which means to establish connectivity between the network namespaces and the host, all you have to do is assign an IP address on the host interface in the virtual network range using the `ip addr add` command

![[nn-23.png]]

- The networks inside of the namespaces are private networks and restricted within the host
	- From within the namespace, you can't reach the outside world and vice versa
	- The only door to the outside world is the internet port on the host

- To configure the bridge to reach the LAN through the ethernet port, we need to add an entry into the routing table that provides a gateway to the outside world, as the routing table is what the namespaces look at to determine if an IP address is reachable

- Since the local host has all of the namespaces and an interface attached to the private network, the local host is the gateway that connects to the two networks together

- Add a route entry in the namespaces to send traffic from the LAN network to the bridge network through its gateway

![[nn-24.png]]

- Keep in mind that even though the host has multiple private addresses, you can't use any of them in the route table because the namespaces have to see the one that leads to the gateway that they have access to

- From the home network, when trying to reach the external internet through the router, the home network has private IP addresses that the destination networks don't know about so they cannot reach back; thus NAT needs to be enabled on the host acting as a gateway

- Network Address Translation (NAT) is a way to map multiple private addresses in a local network to a public IP address before transferring information onto the internet

- To add NAT functionality to the host, we use IPTables, adding a new rule in the post-routing chain to masquerade (or replace) the front IP address on all packets coming from the source network with its own IP address
	- This way, anyone receiving the packets outside of the network will think they're coming from the host and not from within the namespace

- If the LAN is connected to the internet and we want the namespaces to reach the internet, we can simply add a default gateway to the routing table specifying the host so that any network the host can reach, the namespace can reach

![[nn-25.png]]
