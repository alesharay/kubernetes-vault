- When you install <span style="color:#5c7e3e">Docker</span> on a system, it creates its folder structure at <span style="color:red">/var/lib/docker</span>
	- This is where <span style="color:#5c7e3e">Docker</span> stores all of its files related to [[11 - Image Security ✅|images]] and [[7 - Pods ✅|containers]] by default

* ***Note:*** on <span style="color:#5c7e3e">mac</span>, this folder does not exist. In order to see it, fun the following command:

	```docker run -it --rm --privileged --name var-lib-docker --pid=host debian nsenter -t 1 -m -u -n -i sh```

	* `-it` : make the container interactive and provide a cli terminal
	* `--rm`: remove the container once you exit from it
	* `--privilated`: give the container extended privileges
	* `--pid`: the process ID namespace to use

	* `nsenter`: executes a program in the namespaces that is specified in the cli options
	* `-t`: specifies a target process to get contexts from
	* `-m`: the mount namespace for mounting and unmounting filesystems
	* `-u`: the uts namespace for setting hostnames and domainnames
	* `-n`: the network namespace so that the process will have independent
		* IPv4 stacks
		* IP routing tables
		* firewall rules
		* etc....
	* `-i`: the ipc namespace for POSIX message queues etc...

- There are multiple folders under the <span style="color:red">/var/lib/docker</span> directory:
	- aufs
	- containers
	- image
	- volumes
	- etc…

- All files related to [[7 - Pods ✅|containers]] are stored under the <span style="color:red">/var/lib/docker/containers</span> folder

- Any files related to [[11 - Image Security ✅|images]] are stored under the <span style="color:red">/var/lib/docker/images</span> folder

- Any [[3 - Volumes ✅|volumes]] created by the [[7 - Pods ✅|containers]] are created under the <span style="color:red">/var/lib/docker/volumes</span> folder

### Layered Architecture

- When <span style="color:#5c7e3e">Docker</span> builds [[11 - Image Security ✅|images]], it builds them in a layered architecture

- Each line of instruction in the <span style="color:#5c7e3e">Dockerfile</span> creates a new layer in the <span style="color:#5c7e3e">Docker</span> [[11 - Image Security ✅|image]], containing just the changes from the previous layer
![[storage-docker-1.png]]

- Since each layer only contains the changes from the previous layer, it is reflected in the size as well

![[storage-docker-2.png]]

- To understand the advantages of a layered architecture, understand that any <span style="color:#5c7e3e">Dockerfile</span> with the same layers will not need to recreate the layers as they already exist in cache

![[storage-docker-3.png]]

- Storing layers in cache allows <span style="color:#5c7e3e">Docker</span> to build [[11 - Image Security ✅|images]] faster along with efficiently saving space

- The <span style="color:#5c7e3e">Docker</span> layering architecture is also applicable if you were to update your application code, thus saving a lot of time during rebuilds and updates

- When running the <span style="color:red">docker build</span> command, all of the layers are created to form the final <span style="color:#5c7e3e">Docker</span> [[11 - Image Security ✅|image]]

- Once the <span style="color:#5c7e3e">Docker</span> [[11 - Image Security ✅|image]] build is complete, you cannot modify the contents of the layers
	- This means they are read-only and can only be modified by initiating a new build

- When a [[7 - Pods ✅|container]] is run based off the built [[11 - Image Security ✅|image]], <span style="color:#5c7e3e">Docker</span> creates a [[7 - Pods ✅|container]] based on the layers and creates a new writable layer on top of the [[11 - Image Security ✅|image]] layer

- The writeable layer that <span style="color:#5c7e3e">Docker</span> creates upon running a [[7 - Pods ✅|container]] is used to store data created by the [[7 - Pods ✅|container]]
	- such as log files written by the application, any temporary files generated by the [[7 - Pods ✅|container]] or any file modified by the <i><span style="color:#477bbe">user</span></i> on that [[7 - Pods ✅|container]]

![[storage-docker-4.png]]

- The life of the [[7 - Pods ✅|container]] layer remains only as long as the [[7 - Pods ✅|container]] is alive
	- When the [[7 - Pods ✅|container]] is destroyed, the layer along with all of the changes stored in it are destroyed

- The same [[11 - Image Security ✅|image]] layer is shared by all [[7 - Pods ✅|containers]] using the [[11 - Image Security ✅|image]]

- When logging into the <span style="color:#5c7e3e">Docker</span> [[7 - Pods ✅|container]], if a file is created, it is created inside of the [[7 - Pods ✅|container]] layer which is read and write
	- Since the code is baked into the [[11 - Image Security ✅|image]], it is part of the [[11 - Image Security ✅|image]] layer making it read-only

![[storage-docker-5.png]]

- If an existing file is modified inside of a [[7 - Pods ✅|container]], <span style="color:#5c7e3e">Docker</span> automatically creates a copy of the file in the read-write [[7 - Pods ✅|container]] layer which means you will be modifying a different version of the file
	- All future modifications will be done on this 'copied' file

- Copy-on-write mechanism is where <span style="color:#5c7e3e">Docker</span> creates a copy of a file in the [[11 - Image Security ✅|image]] layer into to [[7 - Pods ✅|container]] layer so that the file can be modified

- The [[11 - Image Security ✅|image]] layer being read-only just means that these layers will not be modified in the [[11 - Image Security ✅|image]] itself

- When the [[7 - Pods ✅|container]] is destroyed, all of the data that was stored in the [[7 - Pods ✅|container]] layer also gets destroyed
	- Any files in the [[7 - Pods ✅|container]] layer will also get deleted

- If we would like to persist the data (make available after the container is removed) created when working with [[7 - Pods ✅|containers]], we could add a [[4 - Persistent Volumes ✅|persistent volume]] to the [[7 - Pods ✅|container]]

- To add a [[4 - Persistent Volumes ✅|persistent volume]] to a [[7 - Pods ✅|container]], first create a [[3 - Volumes ✅|volume]] using the <span style="color:red">docker volume create</span> command

- When the <span style="color:red">docker volume create</span> command is run, a folder with the same name given for the [[3 - Volumes ✅|volume]] in the command is created under the <span style="color:red">/var/lib/docker/volumes</span> directory

![[storage-docker-6.png]]

- When running the <span style="color:red">docker run</span> command, the newly created [[3 - Volumes ✅|volume]] will be [[3 - Volumes ✅|mounted]] to the [[7 - Pods ✅|containers's]] read-write layer using the "<span style="color:red">-v HOST_VOLUME_NAME:CONTAINER_VOLUME_LOCATION</span>"

![[storage-docker-7.png]]

- When the new [[7 - Pods ✅|container]] with the [[3 - Volumes ✅|mounted]] <span style="color:#5c7e3e">Docker</span> [[3 - Volumes ✅|volume]] is created, all data written is stored on the [[3 - Volumes ✅|volume]] created on the <span style="color:#5c7e3e">Docker</span> <i><span style="color:#477bbe">host</span></i>
	- Even if the [[7 - Pods ✅|container]] is destroyed, the data is still active

- If you use the "<span style="color:red">-v</span>" option on the <span style="color:red">docker run</span> command with a [[3 - Volumes ✅|volume]] name that doesn't exist yet, <span style="color:#5c7e3e">Docker</span> will automatically create a [[3 - Volumes ✅|volume]] and [[3 - Volumes ✅|mount]] it to the [[7 - Pods ✅|container]]

- You can see the <span style="color:#5c7e3e">Docker</span> [[3 - Volumes ✅|volumes]] by listing the contents of the <span style="color:red">/var/lib/docker/volumes</span> directory
	- This is called [[3 - Volumes ✅|volume]] [[3 - Volumes ✅|mounting]]

- If we want to store data from a different location than the default [[3 - Volumes ✅|volume]] location on the <i><span style="color:#477bbe">host</span></i>, we would run a [[7 - Pods ✅|container]] using the <span style="color:red">docker run -v</span> command but in this case, we provide the full direction of the location
	- This is called [[3 - Volumes ✅|bind mounting]]

![[storage-docker-8.png]]

- There are two types of [[3 - Volumes ✅|mounts]], [[3 - Volumes ✅|volume]] [[3 - Volumes ✅|mounting]] and [[3 - Volumes ✅|bind mounting]]

- [[3 - Volumes ✅|Volume]] [[3 - Volumes ✅|mounting]] [[3 - Volumes ✅|mounts]] [[3 - Volumes ✅|volumes]] from the [[3 - Volumes ✅|volume]] directly

- [[3 - Volumes ✅|Bind mounting]] [[3 - Volumes ✅|mounts]] [[3 - Volumes ✅|volumes]] indirectly from any location on the <span style="color:#5c7e3e">Docker</span> <i><span style="color:#477bbe">host</span></i>

- NOTE: using the <span style="color:red">-v</span> option is the old style. The new way to mount is to use the <span style="color:red">--mount</span> which is the preferred method of [[3 - Volumes ✅|mounting]] [[3 - Volumes ✅|volumes]]

- With the <span style="color:red">--mount</span> option, you have to specify each parameter in a <span style="color:#5c7e3e">key=value</span> format

![[storage-docker-9.png]]

- When using the <span style="color:red">--mount</span> option to [[3 - Volumes ✅|mount]] a [[3 - Volumes ✅|volume]], the type is either <i><span style="color:#477bbe">bind</span></i>, <i><span style="color:#477bbe">volume</span></i>, <i><span style="color:#477bbe">tmpfs</span></i>

- When using the <span style="color:red">--mount</span> option to [[3 - Volumes ✅|mount]] a [[3 - Volumes ✅|volume]], the source is the location on the <i><span style="color:#477bbe">host</span></i>

- When using the <span style="color:red">--mount</span> option to [[3 - Volumes ✅|mount]] a [[3 - Volumes ✅|volume]], the target is the location on the [[7 - Pods ✅|container]]

- So the entity responsible for performing these operations: maintaining the layered architecture, creating a writeable layer, moving files across layers to enable copy and write, etc… is the <b><i><span style="color:#d46644">storage drivers</span></i></b>

- <span style="color:#5c7e3e">Docker</span> uses <b><i><span style="color:#d46644">storage drivers</span></i></b> to enable layered architecture

- Some common <span style="color:#5c7e3e">Docker</span> <b><i><span style="color:#d46644">storage drivers</span></i></b> include AUFS, ZFS, BTRFS, Device Mapper, Overlay, Overlay2

- The selection of the <b><i><span style="color:#d46644">storage driver</span></i></b> depends on the underlying <span style="color:#5c7e3e">OS</span>

- <span style="color:#5c7e3e">Docker</span> will choose the best <b><i><span style="color:#d46644">storage driver</span></i></b> automatically based on the <span style="color:#5c7e3e">OS</span>

- The different <b><i><span style="color:#d46644">storage drivers</span></i></b> also provide different performance and stability characteristics