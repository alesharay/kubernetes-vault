- When you install Docker on a system, it creates its folder structure at /var/lib/docker
	- This is where Docker stores all of its files related to images and containers by default

- There are multiple folders under the /var/lib/docker directory:
	- aufs
	- containers
	- image
	- volumes
	- etc…

- All files related to containers are stored under the <span style="color:red">/var/lib/docker/containers</span> folder

- Any files related to images are stored under the <span style="color:red">/var/lib/docker/images</span> folder

- Any volumes created by the containers are created under the <span style="color:red">/var/lib/docker/volumes</span> folder

### Layered Architecture

- When Docker builds images, it builds them in a layered architecture

- Each line of instruction in the Dockerfile creates a new layer in the Docker image, containing just the changes from the previous layer
![[storage-docker-1.png]]

- Since each layer only contains the changes from the previous layer, it is reflected in the size as well

![[storage-docker-2.png]]

- To understand the advantages of a layered architecture, understand that any Dockerfile with the same layers will not need to recreate the layers as they already exist in cache

![[storage-docker-3.png]]

- Storing layers in cache allows Docker to build images faster along with efficiently saving space

- The Docker layering architecture is also applicable if you were to update your application code, thus saving a lot of time during rebuilds and updates

- When running the <span style="color:red">docker build</span> command, all of the layers are created to form the final docker image

- Once the Docker image build is complete, you cannot modify the contents of the layers
	- This means they are read-only and can only be modified by initiating a new build

- When a container is run based off the built image, Docker creates a container based on the layers and creates a new writable layer on top of the image layer

- The writeable layer that Docker creates upon running a container is used to store data created by the container
	- such as log files written by the application, any temporary files generated by the container or any file modified by the user on that container

![[storage-docker-4.png]]

- The life of the container layer remains only as long as the container is alive
	- When the container is destroyed, the layer along with all of the changes stored in it are destroyed

- The same image layer is shared by all containers using the image

- When logging into the Docker container, if a file is created, it is created inside of the container layer which is read and write
	- Since the code is baked into the image, it is part of the image layer making it read-only

![[storage-docker-5.png]]

- If an existing file is modified inside of a container, Docker automatically creates a copy of the file in the read-write container layer which means you will be modifying a different version of the file
	- All future modifications will be done on this 'copied' file

- Copy-on-write mechanism is where Docker creates a copy of a file in the image layer into to container layer so that the file can be modified

- The image layer being read-only just means that these layers will not be modified in the image itself

- When the container is destroyed, all of the data that was stored in the container layer also get's delivered
	- Any files in the container layer will also get deleted

- If we would like to persist the data created when working with containers, we could add a persistent volume to the container

- To add a Persistent Volume to a container, first create a volume using the <span style="color:red">docker volume create</span> command

- When the <span style="color:red">docker volume create</span> command is run, a folder with the same name given for the volume in the command is created under the /var/lib/docker/volumes directory

![[storage-docker-6.png]]

- When running the <span style="color:red">docker run</span> command, the newly created volume will be mounted to the container's read-write layer using the "-v HOST_VOLUME_NAME:CONTAINER_VOLUME_LOCATION"

![[storage-docker-7.png]]

- When the new container with the mounted Docker volume is created, all data written is stored on the volume created on the Docker host
	- Even if the container is destroyed, the data is still active

- If you use the "-v" option on the <span style="color:red">docker run</span> command with a volume name that doesn't exist yet, Docker will automatically create a volume and mount it to the container

- You can see the Docker volumes by listing the contents of the <span style="color:red">/var/lib/docker/volumes</span> directory
	- This is called volume mounting

- If we want to store data from a different location than the default volume location on the host, we would run a container using the <span style="color:red">docker run -v</span> command but in this case, we provide the full direction of the location
	- This is called bind mounting

![[storage-docker-8.png]]

- There are two types of mounts, volume mounting and bind mounting

- Volume mounting mounts volumes from the volume directly

- Bind mounting mounts volumes indirectly from any location on the Docker host

- NOTE: using the <span style="color:red">-v</span> option is the old style. The new way to mount is to use the <span style="color:red">--mount</span> which is the preferred method of mounting volumes

- With the <span style="color:red">--mount</span> option, you have to specify each parameter in a key=value format

![[storage-docker-9.png]]

- When using the <span style="color:red">--mount</span> option to mount a volume, the type is either bind or mount

- When using the <span style="color:red">--mount</span> option to mount a volume, the source is the location on the host

- When using the <span style="color:red">--mount</span> option to mount a volume, the target is the location on the container

- So the entity responsible for performing these operations: maintaining the layered architecture, creating a writeable layer, moving files across layers to enable copy and write, etc… is the storage drivers

- Docker uses storage drivers to enable layered architecture

- Some common Docker storage drivers include AUFS, ZFS, BTRFS, Device Mapper, Overlay, Overlay2

- The selection of the storage driver depends on the underlying OS

- Docker will choose the best storage driver automatically based on the OS

- The different storage drivers also provide different performance and stability characteristics